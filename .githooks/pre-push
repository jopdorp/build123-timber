#!/bin/bash
# Pre-push hook to rebuild documentation

echo "ðŸ”¨ Building documentation..."

REPO_ROOT="$(git rev-parse --show-toplevel)"
VENV_PATH="$REPO_ROOT/.venv"

# Check if venv exists and activate it
if [ -d "$VENV_PATH" ]; then
    source "$VENV_PATH/bin/activate"
else
    echo "âš ï¸  Virtual environment not found at $VENV_PATH"
    echo "Please create a venv first: uv venv"
    exit 1
fi

# Check if sphinx is installed in venv
if ! command -v sphinx-build &> /dev/null; then
    echo "âš ï¸  Sphinx not installed in venv. Install with: uv pip install -e '.[docs]'"
    echo "Skipping documentation build."
    exit 0
fi

# Navigate to docs directory and build
cd "$REPO_ROOT/docs" || exit 1

# Clean previous build
echo "Cleaning previous build..."
rm -rf _build

# Auto-generate API documentation from source
echo "Generating API documentation..."
rm -rf api/
sphinx-apidoc -o api/ ../src/timber_joints --force --module-first --separate
rm -f api/modules.rst  # Not needed in toctree

# Auto-generate examples.rst from examples/ directory
echo "Generating examples documentation..."
cat > examples.rst << 'EOF'
Examples
========

Complete examples demonstrating library usage.

EOF

# Add each Python file in examples/ directory
for example in ../examples/*.py; do
    if [ -f "$example" ]; then
        filename=$(basename "$example")
        # Convert filename to title (remove .py, replace _ with space, title case)
        title=$(echo "${filename%.py}" | sed 's/_/ /g' | sed 's/\b\(.\)/\u\1/g')
        
        cat >> examples.rst << EOF
$title
$(printf '%*s' ${#title} | tr ' ' '-')

.. literalinclude:: ../examples/$filename
   :language: python
   :linenos:

EOF
    fi
done

# Build HTML documentation
echo "Building HTML documentation..."
if make html; then
    echo "âœ… Documentation built successfully!"
    echo "ðŸ“š View docs at: docs/_build/html/index.html"
else
    echo "âŒ Documentation build failed!"
    echo "Please fix the errors before pushing."
    exit 1
fi

exit 0
